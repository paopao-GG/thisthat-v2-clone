// Markets Database Schema - Separate database for market data only

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client-markets"
}

datasource db {
  provider = "postgresql"
  url      = env("MARKETS_DATABASE_URL")
}

// Market model - Prediction markets (Polymarket + admin-created)
model Market {
  id              String   @id @default(uuid()) @db.Uuid
  polymarketId    String?  @unique @map("polymarket_id") @db.VarChar(255)

  title           String   @db.VarChar(500)
  description     String?  @db.Text
  imageUrl        String?  @map("image_url") @db.Text // Market/event image from Polymarket

  // Binary options (THIS/THAT)
  thisOption      String   @map("this_option") @db.VarChar(255)
  thatOption      String   @map("that_option") @db.VarChar(255)

  // Polymarket Token IDs (P1 - for CLOB API price fetching)
  thisTokenId     String?  @map("this_token_id") @db.VarChar(100) // Token ID for THIS/YES outcome
  thatTokenId     String?  @map("that_token_id") @db.VarChar(100) // Token ID for THAT/NO outcome

  // AMM Reserves (DEPRECATED - kept for backwards compatibility)
  // P1: These are no longer used for pricing - prices come from Polymarket CLOB API
  yesReserve      Decimal  @default(1000.00) @map("yes_reserve") @db.Decimal(20, 8)
  noReserve       Decimal  @default(1000.00) @map("no_reserve") @db.Decimal(20, 8)

  // Cached odds from Polymarket (P1 - updated periodically from CLOB API)
  // When live prices unavailable, these cached values are used as fallback
  thisOdds        Decimal? @map("this_odds") @db.Decimal(5, 4)
  thatOdds        Decimal? @map("that_odds") @db.Decimal(5, 4)

  // Price tracking (P1)
  lastPriceUpdate DateTime? @map("last_price_update") @db.Timestamp()

  // Market metadata
  liquidity       Decimal? @db.Decimal(18, 2)
  volume          Decimal? @db.Decimal(18, 2) // Total volume
  volume24hr      Decimal? @map("volume_24hr") @db.Decimal(18, 2) // 24-hour volume for popularity sorting
  category        String?  @db.VarChar(100)
  marketType      String   @default("polymarket") @map("market_type") @db.VarChar(50) // 'credits', 'polymarket', 'cross'
  status          String   @default("open") @db.VarChar(50) // 'open', 'closed', 'resolved', 'cancelled'
  resolution      String?  @db.VarChar(50) // 'this', 'that', 'invalid'

  // Timing
  expiresAt       DateTime? @map("expires_at") @db.Timestamp()
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamp()
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp()

  @@index([status])
  @@index([category])
  @@index([marketType])
  @@index([polymarketId])
  @@index([volume24hr]) // Index for popularity sorting
  @@index([thisTokenId]) // P1: Index for token ID lookups
  @@map("markets")
}

