// Users Database Schema - Separate database for user data and transactions

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client-users"
}

datasource db {
  provider = "postgresql"
  url      = env("USERS_DATABASE_URL")
}

// User model - Core user data with credits
model User {
  id                  String   @id @default(uuid()) @db.Uuid
  username            String   @unique @db.VarChar(50)
  email               String   @unique @db.VarChar(255)
  name                String?  @db.VarChar(100) // Display name
  profileImageUrl     String?  @map("profile_image_url") @db.VarChar(500) // Profile picture from OAuth provider
  passwordHash        String?  @map("password_hash") @db.VarChar(255) // Optional - OAuth users don't have passwords
  referralCode        String   @unique @default(uuid()) @map("referral_code") @db.VarChar(36)
  referredById        String?  @map("referred_by_id") @db.Uuid
  referralCount       Int      @default(0) @map("referral_count")
  referralCreditsEarned Decimal @default(0.00) @map("referral_credits_earned") @db.Decimal(18, 2)

  // Credits system (V1 only)
  creditBalance       Decimal  @default(1000.00) @map("credit_balance") @db.Decimal(18, 2) // Total balance (legacy, = freeCredits + purchasedCredits)
  availableCredits    Decimal  @default(1000.00) @map("available_credits") @db.Decimal(18, 2) // Credits available for trading
  expendedCredits     Decimal  @default(0.00) @map("expended_credits") @db.Decimal(18, 2) // Total credits spent

  // Separated credit balances
  freeCreditsBalance      Decimal  @default(1000.00) @map("free_credits_balance") @db.Decimal(18, 2) // Free credits (signup bonus, daily rewards, referrals)
  purchasedCreditsBalance Decimal  @default(0.00) @map("purchased_credits_balance") @db.Decimal(18, 2) // Purchased credits (from payments)

  totalVolume         Decimal  @default(0.00) @map("total_volume") @db.Decimal(18, 2)
  overallPnL          Decimal  @default(0.00) @map("overall_pnl") @db.Decimal(18, 2)

  // Leaderboard rankings
  rankByPnL           Int?     @map("rank_by_pnl")
  rankByVolume        Int?     @map("rank_by_volume")

  // Biggest win tracking (profit from single bet)
  biggestWin          Decimal  @default(0.00) @map("biggest_win") @db.Decimal(18, 2)

  // Daily rewards tracking
  lastDailyRewardAt   DateTime? @map("last_daily_reward_at") @db.Timestamp()
  consecutiveDaysOnline Int    @default(1) @map("consecutive_days_online") // Track consecutive login days
  lastLoginAt         DateTime? @map("last_login_at") @db.Timestamp() // Track last login for consecutive days

  // 2x Multiplier system (P4 - Credit Purchase Multiplier)
  multiplierExpiresAt DateTime? @map("multiplier_expires_at") @db.Timestamp()
  multiplierPackageId String?   @map("multiplier_package_id") @db.VarChar(50)

  // Timestamps
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  bets                Bet[]
  creditTransactions  CreditTransaction[]
  dailyRewards        DailyReward[]
  refreshTokens       RefreshToken[]
  stockHoldings       StockHolding[]
  stockTransactions   StockTransaction[]
  creditPurchases     CreditPurchase[]
  payments            Payment[]
  referredUsers       User[]   @relation("UserReferrals")
  referredBy          User?    @relation("UserReferrals", fields: [referredById], references: [id])
  oauthAccounts       OAuthAccount[]
  marketInteractions  UserMarketInteraction[]

  @@index([username])
  @@index([email])
  @@index([rankByPnL])
  @@index([rankByVolume])
  @@index([referralCode])
  @@map("users")
}

// OAuth Account model - Stores OAuth provider accounts (X, Google, etc.)
model OAuthAccount {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  provider          String   @db.VarChar(50) // 'x', 'google', etc.
  providerAccountId String  @map("provider_account_id") @db.VarChar(255) // X user ID
  username          String?  @db.VarChar(100) // X username
  email             String?  @db.VarChar(255)
  accessToken       String?  @map("access_token") @db.Text
  refreshToken      String? @map("refresh_token") @db.Text
  expiresAt         DateTime? @map("expires_at") @db.Timestamp()

  // Social metrics (for analytics)
  followersCount    Int?     @map("followers_count") // X followers count
  followingCount    Int?     @map("following_count") // X following count

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamp()

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@map("oauth_accounts")
}

// Bet model - User bets on markets (AMM share-based)
// Note: marketId references Market.id in the markets database (no foreign key constraint)
model Bet {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  marketId         String   @map("market_id") @db.Uuid // References Market.id in markets database

  // AMM fields
  amount           Decimal  @db.Decimal(18, 2) // Credits spent
  side             String   @db.VarChar(10) // 'this' or 'that'
  creditSource     String   @default("free") @map("credit_source") @db.VarChar(10) // Tracks which wallet funded this bet: 'free' (signup/rewards) or 'purchased' (paid credits)
  sharesReceived   Decimal  @default(0) @map("shares_received") @db.Decimal(20, 8) // Shares received from AMM
  priceAtBet       Decimal  @default(0.5) @map("price_at_bet") @db.Decimal(10, 8) // Price when bet was placed

  // Legacy fields (for backwards compatibility)
  oddsAtBet        Decimal? @map("odds_at_bet") @db.Decimal(5, 4)
  potentialPayout  Decimal? @map("potential_payout") @db.Decimal(18, 2)
  actualPayout     Decimal? @map("actual_payout") @db.Decimal(18, 2)

  status           String   @default("pending") @db.VarChar(50) // 'pending', 'won', 'lost', 'cancelled'

  placedAt         DateTime @default(now()) @map("placed_at") @db.Timestamp()
  resolvedAt       DateTime? @map("resolved_at") @db.Timestamp()

  // Idempotency key to prevent duplicate bets from rapid clicking (optional)
  idempotencyKey   String?  @map("idempotency_key") @db.VarChar(36)

  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([marketId])
  @@index([status])
  @@index([placedAt(sort: Desc)])
  @@index([userId, idempotencyKey])
  @@map("bets")
}

// CreditTransaction model - Audit trail for all credit movements
model CreditTransaction {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid

  amount          Decimal  @db.Decimal(18, 2) // Positive = credit, negative = debit
  transactionType String   @map("transaction_type") @db.VarChar(50) // 'daily_reward', 'bet_placed', 'bet_payout', 'purchase', 'referral_bonus'
  referenceId     String?  @map("reference_id") @db.VarChar(255) // Payment ID, Bet ID, or reward ID (not always UUID)
  balanceAfter    Decimal  @map("balance_after") @db.Decimal(18, 2)

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // CRITICAL: Unique constraint for idempotency - prevents duplicate credits from same payment/bet
  // Only enforces when referenceId is NOT NULL (PostgreSQL partial unique index)
  @@unique([userId, referenceId, transactionType])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("credit_transactions")
}

// CreditPurchase model - Records of credit top-ups (simulated / in-app purchases)
model CreditPurchase {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  packageId       String   @map("package_id") @db.VarChar(50)
  creditsGranted  Decimal  @map("credits_granted") @db.Decimal(18, 2)
  usdAmount       Decimal  @map("usd_amount") @db.Decimal(18, 2)
  status          String   @default("completed") @db.VarChar(20) // 'pending', 'completed', 'failed'
  provider        String?  @db.VarChar(50) // e.g., 'stripe', 'manual'
  externalId      String?  @map("external_id") @db.VarChar(100)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("credit_purchases")
}

// DailyReward model - Track daily login rewards
model DailyReward {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid

  creditsAwarded  Decimal  @default(100.00) @map("credits_awarded") @db.Decimal(18, 2)
  claimedAt       DateTime @default(now()) @map("claimed_at") @db.Timestamp()

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([claimedAt(sort: Desc)])
  @@map("daily_rewards")
}

// RefreshToken model - JWT refresh token management
model RefreshToken {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid

  tokenHash   String   @unique @map("token_hash") @db.VarChar(255)
  expiresAt   DateTime @map("expires_at") @db.Timestamp()
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("refresh_tokens")
}

// Stock model - Tradeable assets in the economy
model Stock {
  id              String   @id @default(uuid()) @db.Uuid
  symbol          String   @unique @db.VarChar(20) // e.g., "THIS", "THAT", "POLY"
  name            String   @db.VarChar(100)
  description     String?  @db.Text
  
  // Stock economics
  currentPrice    Decimal  @default(1.00) @map("current_price") @db.Decimal(18, 8) // Price per share
  totalSupply     Decimal  @default(1000000.00) @map("total_supply") @db.Decimal(18, 2) // Total shares available
  circulatingSupply Decimal @default(0.00) @map("circulating_supply") @db.Decimal(18, 2) // Shares in circulation
  marketCap       Decimal  @default(0.00) @map("market_cap") @db.Decimal(18, 2) // currentPrice * circulatingSupply
  
  // Multipliers and leverage
  baseMultiplier  Decimal  @default(1.00) @map("base_multiplier") @db.Decimal(5, 4) // Base price multiplier
  maxLeverage     Decimal  @default(10.00) @map("max_leverage") @db.Decimal(5, 2) // Maximum leverage allowed
  
  // Status
  status          String   @default("active") @db.VarChar(50) // 'active', 'paused', 'delisted'
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp()
  
  // Relations
  holdings        StockHolding[]
  transactions    StockTransaction[]
  
  @@index([symbol])
  @@index([status])
  @@map("stocks")
}

// StockHolding model - User's stock portfolio
model StockHolding {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  stockId         String   @map("stock_id") @db.Uuid
  
  // Holdings
  shares          Decimal  @default(0.00) @db.Decimal(18, 8) // Number of shares owned
  averageBuyPrice Decimal  @default(0.00) @map("average_buy_price") @db.Decimal(18, 8) // Average purchase price
  totalInvested   Decimal  @default(0.00) @map("total_invested") @db.Decimal(18, 2) // Total credits invested
  
  // Leverage
  leverage        Decimal  @default(1.00) @db.Decimal(5, 2) // Leverage multiplier (1x to maxLeverage)
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp()
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stock           Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  
  @@unique([userId, stockId])
  @@index([userId])
  @@index([stockId])
  @@map("stock_holdings")
}

// StockTransaction model - All stock buy/sell transactions with signing
model StockTransaction {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  stockId         String   @map("stock_id") @db.Uuid
  
  // Transaction details
  type            String   @db.VarChar(20) // 'buy', 'sell'
  shares          Decimal  @db.Decimal(18, 8) // Number of shares
  pricePerShare   Decimal  @map("price_per_share") @db.Decimal(18, 8) // Price at transaction time
  totalAmount      Decimal  @map("total_amount") @db.Decimal(18, 2) // Total credits (shares * price)
  leverage        Decimal  @default(1.00) @db.Decimal(5, 2) // Leverage used
  
  // Transaction signing
  transactionHash String   @unique @map("transaction_hash") @db.VarChar(255) // Unique transaction signature
  signedAt        DateTime @default(now()) @map("signed_at") @db.Timestamp()
  
  // Balance tracking
  balanceBefore   Decimal  @map("balance_before") @db.Decimal(18, 2)
  balanceAfter    Decimal  @map("balance_after") @db.Decimal(18, 2)
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stock           Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([stockId])
  @@index([transactionHash])
  @@index([createdAt(sort: Desc)])
  @@map("stock_transactions")
}

// Payment model - ICPAY payment records for credit purchases
model Payment {
  id                String   @id @db.VarChar(255) // Payment ID from ICPAY
  userId            String   @map("user_id") @db.Uuid
  packageId         String   @map("package_id") @db.VarChar(50)

  // Amounts
  amountUsd         Decimal  @map("amount_usd") @db.Decimal(10, 2)
  amountUsdc        Decimal  @map("amount_usdc") @db.Decimal(18, 6)
  creditsPurchased  Int      @map("credits_purchased")

  // Status tracking
  status            String   @db.VarChar(50) // 'pending', 'completed', 'failed', 'refunded'

  // Blockchain & ICPAY data
  blockchainTxId    String?  @map("blockchain_tx_id") @db.VarChar(255)
  icpayPaymentId    String?  @map("icpay_payment_id") @db.VarChar(255)
  metadata          Json?    @db.JsonB

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamp()
  completedAt       DateTime? @map("completed_at") @db.Timestamp()
  failedAt          DateTime? @map("failed_at") @db.Timestamp()
  failureReason     String?  @map("failure_reason") @db.Text

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  package           CreditPackage @relation(fields: [packageId], references: [id])
  webhookEvents     WebhookEvent[]

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("payments")
}

// CreditPackage model - Predefined credit packages for purchase
model CreditPackage {
  id                String   @id @db.VarChar(50) // 'starter', 'basic', 'popular', 'premium', 'elite'
  name              String   @db.VarChar(100)
  credits           Int      // Number of credits in package
  priceUsd          Decimal  @map("price_usd") @db.Decimal(10, 2)
  bonusPercentage   Int      @default(0) @map("bonus_percentage") // Bonus credits %
  multiplierHours   Int      @default(24) @map("multiplier_hours") // P4: Duration of 2x multiplier in hours
  isActive          Boolean  @default(true) @map("is_active")
  displayOrder      Int      @default(0) @map("display_order")

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  payments          Payment[]

  @@map("credit_packages")
}

// WebhookEvent model - Track all webhook events from ICPAY
model WebhookEvent {
  id                String   @id @db.VarChar(255) // Event ID from ICPAY
  eventType         String   @map("event_type") @db.VarChar(100) // 'payment.completed', 'payment.failed', etc.
  paymentId         String?  @map("payment_id") @db.VarChar(255)
  payload           Json     @db.JsonB
  signature         String   @db.VarChar(255)
  timestamp         BigInt   // Unix timestamp
  processedAt       DateTime @default(now()) @map("processed_at") @db.Timestamp()

  // Relations
  payment           Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@index([paymentId])
  @@index([eventType])
  @@index([timestamp(sort: Desc)])
  @@map("webhook_events")
}

// AnalyticsMetric model - Aggregated analytics metrics computed by daily job
model AnalyticsMetric {
  id            String   @id @default(uuid()) @db.Uuid
  metricName    String   @map("metric_name") @db.VarChar(100)
  metricValue   Decimal  @map("metric_value") @db.Decimal(20, 4)
  dimensions    Json?    @db.JsonB
  periodStart   DateTime @map("period_start") @db.Date
  periodEnd     DateTime @map("period_end") @db.Date
  computedAt    DateTime @default(now()) @map("computed_at") @db.Timestamp()

  @@unique([metricName, periodStart, periodEnd])
  @@index([metricName])
  @@index([periodStart])
  @@map("analytics_metrics")
}

// UTMEvent model - Raw UTM tracking data for attribution
model UTMEvent {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String?  @map("user_id") @db.Uuid
  sessionId     String   @map("session_id") @db.VarChar(100)
  eventType     String   @map("event_type") @db.VarChar(50) // 'page_view', 'signup', 'first_bet', 'purchase'
  utmSource     String?  @map("utm_source") @db.VarChar(100)
  utmMedium     String?  @map("utm_medium") @db.VarChar(100)
  utmCampaign   String?  @map("utm_campaign") @db.VarChar(255)
  utmTerm       String?  @map("utm_term") @db.VarChar(255)
  utmContent    String?  @map("utm_content") @db.VarChar(255)
  referrer      String?  @db.Text
  userAgent     String?  @map("user_agent") @db.Text
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  deviceType    String?  @map("device_type") @db.VarChar(20) // 'mobile', 'tablet', 'desktop'
  country       String?  @db.VarChar(100)
  city          String?  @db.VarChar(100)
  pageUrl       String?  @map("page_url") @db.Text
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([userId])
  @@index([sessionId])
  @@index([eventType])
  @@index([createdAt(sort: Desc)])
  @@index([utmSource])
  @@index([utmCampaign])
  @@map("utm_events")
}

// UserMarketInteraction model - Track user interactions with markets (skip/view/bet)
model UserMarketInteraction {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  marketId    String   @map("market_id") @db.Uuid // References Market.id in markets database

  action      String   @db.VarChar(20) // 'skip' | 'bet'
  timestamp   DateTime @default(now()) @db.Timestamp()
  expiresAt   DateTime @map("expires_at") @db.Timestamp() // When skip expires (3 days from timestamp)

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, marketId])
  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
  @@map("user_market_interactions")
}

